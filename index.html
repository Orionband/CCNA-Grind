<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCNA Practice</title>
    
    <!-- Chart.js Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/dist/date-fns.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Chart.js Plugin for Data Labels -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.1.0"></script>


    <style>
        :root {
            /* Color Palette - Light Mode */
            --bg-color: #f8f9fa;
            --surface-color: #ffffff;
            --surface-alt-color: #f8f9fa;
            --text-color: #212529;
            --text-muted-color: #6c757d;
            --border-color: #dee2e6;
            --accent-color: #0d6efd;
            --accent-hover-color: #0b5ed7;
            --danger-color: #dc3545;
            --danger-hover-color: #bb2d3b;
            --success-bg: #d1e7dd;
            --success-border: #a3cfbb;
            --error-bg: #f8d7da;
            --error-border: #f1aeb5;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --icon-fill: #495057;

            /* Transitions */
            --transition-speed: 0.3s;
        }

        .dark-mode {
            /* Color Palette - Dark Mode */
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --surface-alt-color: #2a2a2a;
            --text-color: #e0e0e0;
            --text-muted-color: #888;
            --border-color: #3a3a3a;
            --accent-color: #3b82f6;
            --accent-hover-color: #2563eb;
            --danger-color: #f43f5e;
            --danger-hover-color: #e11d48;
            --success-bg: #143625;
            --success-border: #2f684a;
            --error-bg: #4d1822;
            --error-border: #8c2a3e;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --icon-fill: #e0e0e0;
        }

        /* General Styling */
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 2rem;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }
        .container {
            width: 100%;
            max-width: 900px;
            background: var(--surface-color);
            padding: 2rem 3rem;
            border-radius: 16px;
            box-shadow: 0 10px 30px -15px var(--shadow-color);
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-speed), border-color var(--transition-speed);
            position: relative;
        }

        /* Header and Dark Mode Toggle */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
        }
        h1 {
            color: var(--accent-color);
            margin: 0;
            font-size: 2.25rem;
        }
        h2 {
            text-align: center;
            color: var(--text-color);
            padding-bottom: 10px;
        }
        #darkModeToggle {
            background: none;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            transition: background-color var(--transition-speed), border-color var(--transition-speed);
        }
        #darkModeToggle:hover {
            background-color: var(--surface-alt-color);
        }
        #darkModeToggle svg {
            width: 24px;
            height: 24px;
            fill: var(--icon-fill);
            transition: fill var(--transition-speed);
        }
        
        /* Options Panel */
        .options-panel {
            padding: 1.5rem;
            background-color: var(--surface-alt-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 2rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            justify-content: center;
            align-items: center;
        }
        .option-group {
            display: flex;
            flex-direction: column;
        }
        .option-group label {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: var(--text-muted-color);
        }
        .option-group input[type="number"], .option-group select {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--surface-color);
            color: var(--text-color);
            width: 180px;
            font-size: 1em;
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
        }
        .option-group input[type="number"]:focus, .option-group select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-color) 20%, transparent);
        }
        .option-group-checkbox {
            display: flex; align-items: center; gap: 10px; padding-top: 20px;
        }
        .option-group-checkbox label { margin-bottom: 0; }

        /* Dashboard & Charts */
        #dashboardContainer, .chart-summary-container {
            margin-bottom: 20px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background-color: var(--surface-color);
        }
        .chart-container { display: grid; grid-template-columns: 1fr; gap: 2rem; }
        .chart-wrapper { position: relative; height: 350px; }
        .chart-summary-container h3 { text-align: center; margin-top: 0; }

        /* Category Descriptions */
        #categoryDescriptions {
            margin-bottom: 1.5rem; padding: 1rem 1.5rem; background-color: var(--surface-alt-color);
            border: 1px solid var(--border-color); border-radius: 12px;
        }
        #categoryDescriptions summary { font-weight: 600; cursor: pointer; color: var(--accent-color); }
        #categoryList { list-style-type: none; padding-left: 0; margin-top: 10px; column-count: 2; column-gap: 20px; }
        #categoryList li { margin-bottom: 8px; font-size: 0.9em; }
        #categoryList li strong { display: inline-block; width: 65px; font-family: "Courier New", Courier, monospace; color: var(--text-muted-color); }
        @media (max-width: 600px) { #categoryList { column-count: 1; } }

        /* Buttons */
        button {
            background-color: var(--accent-color); color: white; border: none; padding: 14px 28px;
            border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600;
            transition: background-color var(--transition-speed), transform 0.1s ease-out, box-shadow var(--transition-speed);
        }
        button:hover {
            background-color: var(--accent-hover-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px -5px color-mix(in srgb, var(--accent-color) 50%, transparent);
        }
        button:disabled {
            background-color: var(--text-muted-color); cursor: not-allowed; transform: none; box-shadow: none;
        }
        .clear-data-btn {
            background-color: var(--danger-color); font-size: 12px; padding: 5px 10px; margin-top: 15px;
        }
        .clear-data-btn:hover { background-color: var(--danger-hover-color); }
        .submit-btn, .restart-btn { display: block; width: 220px; margin: 30px auto; }

        /* Quiz Specific Styling */
        .question { margin-bottom: 2.5rem; padding-bottom: 2rem; border-bottom: 1px solid var(--border-color); }
        .question-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .question-text { font-weight: 600; font-size: 1.15em; flex-grow: 1; }
        .question-category { color: var(--text-muted-color); font-weight: 500; font-size: 0.9em; margin-right: 8px; }
        .bookmark-btn {
            background: none; border: none; font-size: 24px; cursor: pointer; padding: 0; line-height: 1;
            opacity: 0.5; transition: opacity 0.2s, transform 0.2s;
        }
        .bookmark-btn.bookmarked { opacity: 1; transform: scale(1.2); }
        .question-exhibit, .question-exhibit-frame {
            max-width: 100%; height: auto; border-radius: 8px; margin: 15px 0; border: 1px solid var(--border-color);
        }
        .question-exhibit-frame { width: 100%; height: 350px; }
        .exhibit-container {
            margin: 15px 0; border: 1px solid var(--border-color); border-radius: 8px;
            background-color: var(--surface-alt-color);
        }
        .exhibit-container strong {
            display: block; padding: 8px 12px; background-color: color-mix(in srgb, var(--surface-alt-color) 80%, black 20%);
            border-bottom: 1px solid var(--border-color); border-top-left-radius: 8px; border-top-right-radius: 8px;
            font-size: 0.9em;
        }
        .question-exhibit-text {
            padding: 15px; white-space: pre-wrap; word-wrap: break-word; font-family: "Courier New", Courier, monospace;
            font-size: 0.9em; margin: 0; background-color: var(--surface-alt-color);
            border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; color: var(--text-color);
        }
        .answer-choice {
            margin-bottom: 12px; padding: 14px; border-radius: 8px; display: block; cursor: pointer;
            border: 1px solid var(--border-color); background-color: var(--surface-color);
            transition: background-color var(--transition-speed), border-color var(--transition-speed);
            position: relative; padding-left: 45px;
        }
        .answer-choice:hover { background-color: var(--surface-alt-color); border-color: var(--accent-color); }
        .fb-input {
            padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1em; margin: 0 5px; width: 200px;
            background-color: var(--surface-color); color: var(--text-color);
        }
        .fb-input.correct { border-color: var(--success-border); background-color: var(--success-bg); }
        .fb-input.incorrect { border-color: var(--error-border); background-color: var(--error-bg); }
        
        /* Results & Answer Styling */
        .result-explanation {
            background-color: var(--surface-alt-color); border-left: 5px solid var(--accent-color);
            padding: 15px; margin-top: 20px; border-radius: 5px;
        }
        .correct { background-color: var(--success-bg); border: 1px solid var(--success-border); font-weight: 600; }
        .incorrect { background-color: var(--error-bg); border: 1px solid var(--error-border); }
        .hidden { display: none; }
        
        /* Custom Checkbox and Radio Styles */
        .answer-choice input { position: absolute; opacity: 0; cursor: pointer; }
        .checkmark {
            position: absolute; top: 50%; left: 15px; transform: translateY(-50%);
            height: 22px; width: 22px; background-color: var(--surface-alt-color);
            border: 1px solid var(--border-color); border-radius: 6px;
            transition: background-color var(--transition-speed), border-color var(--transition-speed);
        }
        .answer-choice:hover .checkmark { border-color: var(--accent-color); }
        .answer-choice input:checked ~ .checkmark { background-color: var(--accent-color); border-color: var(--accent-color); }
        .checkmark:after { content: ""; position: absolute; display: none; }
        .answer-choice input:checked ~ .checkmark:after { display: block; }
        .answer-choice input[type="checkbox"] ~ .checkmark:after {
            left: 7px; top: 3px; width: 5px; height: 10px; border: solid white;
            border-width: 0 3px 3px 0; transform: rotate(45deg);
        }
        .answer-choice input[type="radio"] ~ .checkmark { border-radius: 50%; }
        .answer-choice input[type="radio"] ~ .checkmark:after {
            left: 50%; top: 50%; transform: translate(-50%, -50%);
            width: 10px; height: 10px; border-radius: 50%; background: white;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>CCNA Practice</h1>
            <button id="darkModeToggle" title="Toggle Dark Mode">
                <!-- Icons will be injected by JS -->
            </button>
        </div>
        
        <div id="mainScreen">
            <div id="dashboardContainer">
                <h2>Dashboard</h2>
                <div class="chart-container">
                    <div class="chart-wrapper">
                        <canvas id="categoryChart"></canvas>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="historyChart"></canvas>
                    </div>
                </div>
                <button id="clearDataBtn" class="clear-data-btn">Clear All Study Data</button>
            </div>
            
            <div id="categoryDescriptions">
                <details>
                    <summary>View CCNA Topic Domains</summary>
                    <ul id="categoryList"></ul>
                </details>
            </div>

            <div id="optionsPanel" class="options-panel">
                 <div class="option-group">
                    <label for="modeSelect">Quiz Mode:</label>
                    <select id="modeSelect">
                        <option value="standard">Standard</option>
                        <option value="mistakes">Practice My Mistakes</option>
                        <option value="flagged">Review Flagged Questions</option>
                    </select>
                </div>
                <div class="option-group">
                    <label for="categorySelect">Filter by Topic:</label>
                    <select id="categorySelect">
                        <option value="ALL">All Topics</option>
                    </select>
                </div>
                <div class="option-group">
                    <label for="numQuestions">Questions:</label>
                    <input type="number" id="numQuestions" value="10" min="1">
                </div>
                <div class="option-group-checkbox">
                    <label for="randomize">Randomize:</label>
                    <input type="checkbox" id="randomize" checked>
                </div>
                <button id="startBtn" disabled>Loading...</button>
            </div>
        </div>

        <div id="quizContainer" class="hidden"></div>
        <div id="resultsContainer"></div>
    </div>

    <script>
    const startBtn = document.getElementById('startBtn');
    const quizContainer = document.getElementById('quizContainer');
    const resultsContainer = document.getElementById('resultsContainer');
    const mainScreen = document.getElementById('mainScreen');
    const categorySelect = document.getElementById('categorySelect');
    const modeSelect = document.getElementById('modeSelect');

    const CATEGORY_MAP = {
        "NETFD": "Network Fundamentals", "NETSEC": "Network Security & Access Control", "IPNS": "IP Networking & Services",
        "ROSW": "Routing & Switching", "OPTR": "Operations & Troubleshooting", "WWCN": "Wireless & WAN Connectivity",
        "NAPR": "Network Automation and Programmability"
    };

    let allQuestions = [];
    let currentQuizQuestions = [];
    let currentQuizAttempt = null;
    let quizHistory = [];
    let bookmarkedQuestions = [];
    let chartInstances = {};

    // --- DARK MODE LOGIC ---
    const darkModeToggle = document.getElementById('darkModeToggle');
    const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.106a.75.75 0 010 1.06l-1.591 1.59a.75.75 0 11-1.06-1.06l1.59-1.59a.75.75 0 011.06 0zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5h2.25a.75.75 0 01.75.75zM17.836 17.836a.75.75 0 01-1.06 0l-1.59-1.591a.75.75 0 111.06-1.06l1.59 1.59a.75.75 0 010 1.061zM12 18a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.964 17.836a.75.75 0 010-1.06l-1.59-1.59a.75.75 0 01-1.061 1.06l1.59 1.59a.75.75 0 011.06 0zM4.5 12a.75.75 0 01-.75.75H1.5a.75.75 0 010-1.5h2.25a.75.75 0 01.75.75zM6.106 6.106a.75.75 0 011.06 0l1.591 1.59a.75.75 0 01-1.06 1.06l-1.59-1.591a.75.75 0 010-1.06z"/></svg>`;
    const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 003.463-.69.75.75 0 01.981.981A10.503 10.503 0 0112 21a10.5 10.5 0 01-10.5-10.5c0-4.368 2.667-8.112 6.46-9.772a.75.75 0 01.818.162z" /></svg>`;
    
    function setDarkMode(isDark) {
        if (isDark) {
            document.documentElement.classList.add('dark-mode');
            darkModeToggle.innerHTML = sunIcon;
            localStorage.setItem('theme', 'dark');
        } else {
            document.documentElement.classList.remove('dark-mode');
            darkModeToggle.innerHTML = moonIcon;
            localStorage.setItem('theme', 'light');
        }
        // Re-render charts with new theme colors
        renderDashboard();
        if (quizContainer.classList.contains('hidden') && resultsContainer.innerHTML !== '') {
            renderQuizSummaryChart(currentQuizAttempt);
        }
    }

    darkModeToggle.addEventListener('click', () => {
        const isDark = !document.documentElement.classList.contains('dark-mode');
        setDarkMode(isDark);
    });

    // --- END DARK MODE LOGIC ---

    document.addEventListener('DOMContentLoaded', () => {
        Chart.register(ChartDataLabels);

        // Apply saved theme on page load
        const savedTheme = localStorage.getItem('theme');
        setDarkMode(savedTheme === 'dark');

        loadDataFromStorage();
        populateCategoryFilter();
        populateCategoryDescriptions();
        renderDashboard(); 
        loadQuestions(); 

        startBtn.addEventListener('click', loadAndDisplayQuiz);
        modeSelect.addEventListener('change', updateMaxQuestions);
        document.getElementById('clearDataBtn').addEventListener('click', clearAllData);
    });
    
    // --- UTILITY AND DATA FUNCTIONS ---
    function loadDataFromStorage() {
        quizHistory = JSON.parse(localStorage.getItem('quizHistory')) || [];
        bookmarkedQuestions = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
    }
    
    function saveDataToStorage() {
        localStorage.setItem('quizHistory', JSON.stringify(quizHistory));
        localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarkedQuestions));
    }

    function clearAllData() {
        if (confirm("Are you sure you want to delete all your quiz history and bookmarks? This cannot be undone.")) {
            quizHistory = []; bookmarkedQuestions = []; saveDataToStorage();
            renderDashboard(); updateMaxQuestions();
            alert("All study data has been cleared.");
        }
    }

    // --- SETUP AND UI POPULATION ---
    function populateCategoryDescriptions() {
        const listElement = document.getElementById('categoryList');
        if (!listElement) return;
        listElement.innerHTML = Object.entries(CATEGORY_MAP).sort((a, b) => a[1].localeCompare(b[1]))
            .map(([code, description]) => `<li><strong>${code}</strong> - ${description}</li>`).join('');
    }

    function populateCategoryFilter() {
        Object.entries(CATEGORY_MAP).sort((a, b) => a[1].localeCompare(b[1])).forEach(([code, description]) => {
            categorySelect.appendChild(new Option(description, code));
        });
    }
    
    function getMistakeQuestionIds() {
        const mistakeIds = new Set();
        quizHistory.forEach(quiz => quiz.questions.forEach(q => { if (!q.isCorrect) mistakeIds.add(q.questionId); }));
        return Array.from(mistakeIds);
    }
    
    // --- QUESTION LOADING AND QUIZ LOGIC ---
    function updateMaxQuestions() {
        const mode = modeSelect.value;
        const category = categorySelect.value;
        let pool = [];

        if (mode === 'standard') {
            pool = (category === 'ALL') ? allQuestions : allQuestions.filter(q => q.cat === category);
        } else if (mode === 'mistakes') {
            const mistakeIds = getMistakeQuestionIds();
            pool = allQuestions.filter(q => mistakeIds.includes(q.questionId) && (category === 'ALL' || q.cat === category));
        } else if (mode === 'flagged') {
            pool = allQuestions.filter(q => bookmarkedQuestions.includes(q.questionId) && (category === 'ALL' || q.cat === category));
        }
        
        const numInput = document.getElementById('numQuestions');
        numInput.max = pool.length;
        if (pool.length > 0) {
           numInput.value = Math.min(parseInt(numInput.value, 10) || 10, pool.length);
           startBtn.disabled = false;
           startBtn.textContent = 'Start Test';
        } else {
           numInput.value = 0;
           startBtn.disabled = true;
           startBtn.textContent = 'No Questions in Pool';
        }
    }

    async function loadQuestions() {
        startBtn.disabled = true;
        startBtn.textContent = 'Loading Deck...';
        try {
            const response = await fetch('questions.json');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            allQuestions = data; // Assuming normalization is not strictly needed now
            updateMaxQuestions();
        } catch (error) {
            console.error(`Error fetching questions.json:`, error);
            mainScreen.innerHTML = `<p style="color: var(--danger-color); text-align: center;">CRITICAL ERROR: Could not load questions.json. Ensure it's in the same folder and there are no network issues.</p>`;
            startBtn.textContent = 'Load Failed';
        }
    }

    function loadAndDisplayQuiz() {
        const numQuestionsInput = document.getElementById('numQuestions');
        const randomize = document.getElementById('randomize').checked;
        const mode = modeSelect.value;
        const category = categorySelect.value;
        
        let questionPool = [];
        if (mode === 'mistakes') {
            const mistakeIds = getMistakeQuestionIds();
            questionPool = allQuestions.filter(q => mistakeIds.includes(q.questionId));
        } else if (mode === 'flagged') {
            questionPool = allQuestions.filter(q => bookmarkedQuestions.includes(q.questionId));
        } else {
            questionPool = allQuestions;
        }
        
        if (category !== 'ALL') {
            questionPool = questionPool.filter(q => q.cat === category);
        }

        if (questionPool.length === 0) {
            alert("There are no questions available for your selected criteria. Try a different mode or topic.");
            return;
        }

        const numQuestions = Math.min(parseInt(numQuestionsInput.value), questionPool.length);
        currentQuizQuestions = randomize ? [...questionPool].sort(() => 0.5 - Math.random()).slice(0, numQuestions) : questionPool.slice(0, numQuestions);
        
        displayQuiz();
    }

    function displayQuiz() {
        mainScreen.classList.add('hidden');
        quizContainer.classList.remove('hidden');
        resultsContainer.innerHTML = '';
        quizContainer.innerHTML = '';

        let quizHtml = '<h2>Quiz</h2>';
        currentQuizQuestions.forEach((q, index) => {
            const isBookmarked = bookmarkedQuestions.includes(q.questionId);
            const bookmarkedClass = isBookmarked ? 'bookmarked' : '';
            const inputType = (q.answerChoices.filter(c => c.IsCorrect).length > 1) ? 'checkbox' : 'radio';

            let questionTextHtml = `
                <div class="question-header">
                    <button class="bookmark-btn ${bookmarkedClass}" onclick="toggleBookmark('${q.questionId}', this)">ðŸš©</button>
                    <div class="question-text">
                        ${index + 1}. <span class="question-category">(${(q.cat || 'N/A')})</span> ${q.questionText}
                    </div>
                </div>`;
            
            quizHtml += `<div class="question" id="q-${index}" data-question-id="${q.questionId}">${questionTextHtml}`;

            if (q.exhibits && q.exhibits.length > 0) {
                 q.exhibits.forEach(exhibit => {
                    const localPath = `./images/${exhibit.ExhibitFileName.split('/').pop().replaceAll(':', '_')}`;
                    quizHtml += `<div class="exhibit-container"><strong>Exhibit</strong><pre class="question-exhibit-text">${exhibit.textContent || 'Exhibit content not loaded.'}</pre></div>`;
                });
            }

            if (q.answerChoices) {
                 q.answerChoices.forEach((choice, choiceIndex) => {
                    quizHtml += `<label class="answer-choice">${choice.Text}<input type="${inputType}" name="question-${index}" value="${choiceIndex}"><span class="checkmark"></span></label>`;
                });
            }
            quizHtml += `</div>`;
        });
        
        quizHtml += '<button id="submitBtn" class="submit-btn">Submit Test</button>';
        quizContainer.innerHTML = quizHtml;
        document.getElementById('submitBtn').addEventListener('click', showResults);
    }
    
    function toggleBookmark(questionId, buttonElement) {
        const index = bookmarkedQuestions.indexOf(questionId);
        if (index > -1) {
            bookmarkedQuestions.splice(index, 1);
            buttonElement.classList.remove('bookmarked');
        } else {
            bookmarkedQuestions.push(questionId);
            buttonElement.classList.add('bookmarked');
        }
        saveDataToStorage();
    }
    
    function showResults() {
        let score = 0;
        currentQuizAttempt = { timestamp: Date.now(), score: 0, total: currentQuizQuestions.length, questions: [] };
        
        currentQuizQuestions.forEach((q, index) => {
            const userChoices = Array.from(document.querySelectorAll(`input[name="question-${index}"]:checked`));
            const userAnswers = userChoices.map(input => parseInt(input.value));
            const correctAnswers = q.answerChoices.map((choice, i) => choice.IsCorrect ? i : -1).filter(i => i !== -1);
            const isCorrect = userAnswers.length === correctAnswers.length && userAnswers.sort().toString() === correctAnswers.sort().toString();

            if (isCorrect) score++;
            currentQuizAttempt.questions.push({ questionId: q.questionId, isCorrect, category: q.cat });
        });
        
        currentQuizAttempt.score = score;
        quizHistory.push(currentQuizAttempt);
        saveDataToStorage();
        renderDashboard();
        
        document.getElementById('submitBtn').remove();
        
        // --- Build Results View ---
        resultsContainer.innerHTML = '';
        const scorePercentage = Math.round((score / currentQuizQuestions.length) * 100);
        const scoreHeader = document.createElement('h2');
        scoreHeader.textContent = `Your Score: ${score} out of ${currentQuizQuestions.length} (${scorePercentage}%)`;
        resultsContainer.appendChild(scoreHeader);
        
        const summaryContainer = document.createElement('div');
        summaryContainer.className = 'chart-summary-container';
        summaryContainer.innerHTML = '<h3>This Quiz Performance</h3><canvas id="quizSummaryChart"></canvas>';
        resultsContainer.appendChild(summaryContainer);
        
        const uniqueCategoriesInQuiz = new Set(currentQuizAttempt.questions.map(q => q.category || 'N/A'));
        const dynamicHeight = Math.max(150, (uniqueCategoriesInQuiz.size * 40) + 80); 
        summaryContainer.style.height = `${dynamicHeight}px`;
        renderQuizSummaryChart(currentQuizAttempt);
        
        revealAnswers();
        
        const restartBtn = document.createElement('button');
        restartBtn.className = 'restart-btn';
        restartBtn.textContent = 'Take Another Test';
        restartBtn.onclick = () => {
             mainScreen.classList.remove('hidden');
             quizContainer.classList.add('hidden');
             quizContainer.innerHTML = '';
             resultsContainer.innerHTML = '';
             currentQuizAttempt = null;
             updateMaxQuestions();
        };
        resultsContainer.appendChild(restartBtn);
    }
    
    function revealAnswers() {
        currentQuizQuestions.forEach((q, index) => {
            const questionElement = document.getElementById(`q-${index}`);
            const userChoices = Array.from(questionElement.querySelectorAll(`input[type="checkbox"]:checked, input[type="radio"]:checked`));
            const userAnswers = userChoices.map(input => parseInt(input.value));
            
            questionElement.querySelectorAll('.answer-choice').forEach((label, choiceIndex) => {
                if (q.answerChoices[choiceIndex].IsCorrect) {
                    label.classList.add('correct');
                } else if (userAnswers.includes(choiceIndex)) {
                    label.classList.add('incorrect');
                }
            });
            const explanationHtml = `<div class="result-explanation">${q.explanation || 'No explanation provided.'}</div>`;
            questionElement.insertAdjacentHTML('beforeend', explanationHtml);
        });
        quizContainer.querySelectorAll('input').forEach(input => input.disabled = true);
    }
    
    // --- CHART RENDERING ---
    function getChartThemeOptions() {
        const isDark = document.documentElement.classList.contains('dark-mode');
        const textColor = isDark ? '#e0e0e0' : '#6c757d';
        const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        return {
            color: textColor,
            scales: {
                x: { ticks: { color: textColor }, grid: { color: gridColor, borderColor: gridColor } },
                y: { ticks: { color: textColor }, grid: { color: gridColor, borderColor: gridColor } }
            }
        };
    }
    
    function renderQuizSummaryChart(quizAttempt) {
        if (!quizAttempt) return;
        const ctx = document.getElementById('quizSummaryChart')?.getContext('2d');
        if (!ctx) return;
        if (chartInstances.summary) chartInstances.summary.destroy();

        const categoryStats = {};
        quizAttempt.questions.forEach(qResult => {
            const cat = qResult.category || 'N/A';
            if (!categoryStats[cat]) categoryStats[cat] = { correct: 0, total: 0 };
            categoryStats[cat].total++;
            if (qResult.isCorrect) categoryStats[cat].correct++;
        });
        
        const labels = Object.keys(categoryStats).map(cat => CATEGORY_MAP[cat] || cat);
        const data = Object.values(categoryStats).map(stats => (stats.correct / stats.total) * 100);

        chartInstances.summary = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label: '% Correct', data, backgroundColor: 'rgba(25, 135, 84, 0.7)' }] },
            options: {
                ...getChartThemeOptions(),
                indexAxis: 'y',
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, datalabels: { color: '#fff', formatter: (v) => v.toFixed(0) + '%' } }
            }
        });
    }
    
    function renderCategoryChart() {
        const ctx = document.getElementById('categoryChart')?.getContext('2d');
        if (!ctx) return;
        const container = ctx.canvas.parentNode;
        container.style.height = `${(Object.keys(CATEGORY_MAP).length * 35) + 80}px`;

        if (chartInstances.category) chartInstances.category.destroy();

        const categoryStats = Object.fromEntries(Object.keys(CATEGORY_MAP).map(code => [code, { correct: 0, total: 0 }]));
        quizHistory.forEach(quiz => quiz.questions.forEach(q => {
            if (q.category && categoryStats[q.category]) {
                categoryStats[q.category].total++;
                if (q.isCorrect) categoryStats[q.category].correct++;
            }
        }));
        
        const sortedCodes = Object.keys(CATEGORY_MAP).sort((a,b) => CATEGORY_MAP[a].localeCompare(CATEGORY_MAP[b]));
        const labels = sortedCodes.map(code => CATEGORY_MAP[code]);
        const data = sortedCodes.map(code => {
            const stats = categoryStats[code];
            return stats.total > 0 ? (stats.correct / stats.total) * 100 : 0;
        });

        chartInstances.category = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label: '% Correct', data, backgroundColor: 'rgba(13, 110, 253, 0.7)' }] },
            options: {
                ...getChartThemeOptions(),
                indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    title: { display: true, text: 'Overall Performance by Topic', color: getChartThemeOptions().color },
                    datalabels: { color: '#fff', formatter: (v) => v > 0 ? v.toFixed(0) + '%' : '' } 
                }
            }
        });
    }

    function renderHistoryChart() {
        const ctx = document.getElementById('historyChart')?.getContext('2d');
        if (!ctx) return;
        if (chartInstances.history) chartInstances.history.destroy();
        
        const chartData = quizHistory.map(quiz => ({ x: quiz.timestamp, y: (quiz.score / quiz.total) * 100 }));

        chartInstances.history = new Chart(ctx, {
            type: 'line',
            data: { datasets: [{ label: 'Score %', data: chartData, borderColor: 'rgb(25, 135, 84)', tension: 0.1 }] },
            options: {
                ...getChartThemeOptions(),
                responsive: true, maintainAspectRatio: false,
                scales: { x: { ...getChartThemeOptions().scales.x, type: 'time', time: { unit: 'day', tooltipFormat: 'PP' } }, y: getChartThemeOptions().scales.y },
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'Score Over Time', color: getChartThemeOptions().color },
                    datalabels: { display: false }
                }
            }
        });
    }
    </script>
</body>
</html>
